<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chrome Sync Tool</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 500px; margin: auto; }
    input, button, select {
      padding: 10px;
      margin: 10px 0;
      width: 100%;
      border-radius: 6px;
      border: 1px solid #b4b4b4;
      box-sizing: border-box;
    }
    label { font-weight: bold; }
    .primary { background-color: #007bff; color: white; border: none; }
    .disabled { background-color: #ccc; color: #666; cursor: not-allowed; }
    .loading:after {
      content: " â³";
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .header {
      display: flex;
      justify-content: space-between;

    }
    .account-list-button {
      padding: 0; margin: 0; text-align: right; 
      font-size: 0.8em;
      font-weight: 300;
      color: #007bff;
      border: none;
      background: none;
      cursor: pointer;
      padding: 0;
    }
  </style>
</head>
<body>
    <h2>Chrome Sync Tool</h2>
    <button class="account-list-button" onclick="openProfileList()">[ê³„ì • ë¦¬ìŠ¤íŠ¸]</button>
  <div style="display: flex; align-items: center; gap: 10px;">
    <label for="count" style="white-space: nowrap;">ë¸Œë¼ìš°ì € ê°œìˆ˜ (2~20):</label>
    <input id="count" type="number" min="2" max="20" value="2" style="flex: 1;">
  </div>

  <button id="launch-btn" class="primary" onclick="launchChromes()">1. í¬ë¡¬ì°½ ì—´ê¸°</button>

  <div id="master-guidance" style="display:none; text-align: center; margin-top: 10px;">
    <p style="font-size: 0.8em; font-weight: 400;">í˜ì´ì§€ ê°œë³„ ì„¸íŒ…ì„ ë§ˆì¹œ í›„ ë§ˆìŠ¤í„° ì°½ ì„ íƒ</p>
  </div>

  <button id="master-btn" class="disabled" disabled onclick="selectMaster()">2. ë§ˆìŠ¤í„° ì°½ ì„ íƒ</button>

  <div id="master-select-box" style="display:none;">
    <div style="text-align: left;">
      <label for="master">ë§ˆìŠ¤í„° ì°½ ì„ íƒ:</label>
      <select id="master"></select>
      <button onclick="confirmMaster()">ì„ íƒ ì™„ë£Œ</button>
    </div>
  </div>

  <button id="sync-btn" class="disabled" disabled onclick="startSync()">3. ë™ê¸°í™” ì‹œì‘í•˜ê¸°</button>
  <button id="stop-sync-btn" class="disabled" disabled onclick="stopSync()">ë™ê¸°í™” ì¢…ë£Œí•˜ê¸°</button>
  <button onclick="exitApp()">4. ì¢…ë£Œ</button>
  <button style="padding: 0; margin: 0; text-align: right; font-size: 0.8em; font-weight: 200; border: none; background-color: #ffffff;" onclick="closeAllChromes()"> ëª¨ë“  í¬ë¡¬ ì°½ ë‹«ê¸°</button>

  <script>
    const { ipcRenderer } = require('electron');
    let chromeList = [];
    let selectedMasterIndex = null;

    async function launchChromes() {
      const count = parseInt(document.getElementById('count').value);
      if (count < 2 || count > 20) return alert('2~20 ì‚¬ì´ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”');
      try {
        const result = await ipcRenderer.invoke('launch-chromes', count);
        if (result.success) {
          alert(`${result.length}ê°œì˜ í¬ë¡¬ ì°½ì´ ì—´ë ¸ìŠµë‹ˆë‹¤.`);

          document.getElementById('launch-btn').classList.remove('primary');
          document.getElementById('launch-btn').classList.add('disabled');
          document.getElementById('launch-btn').disabled = true;

          const masterBtn = document.getElementById('master-btn');
          masterBtn.classList.remove('disabled');
          masterBtn.classList.add('primary');
          masterBtn.disabled = false;

          document.getElementById('master-guidance').style.display = 'block';
        } else {
          console.error('âŒ í¬ë¡¬ ì‹¤í–‰ ì‹¤íŒ¨:', result.error);
          alert('í¬ë¡¬ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
        }
      } catch (err) {
        console.error(err);
        alert('í¬ë¡¬ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
      }
    }

    async function selectMaster() {
      const count = parseInt(document.getElementById('count').value);
      const list = await ipcRenderer.invoke('get-browser-list', count);
      chromeList = list;
      const select = document.getElementById('master');
      select.innerHTML = '';
      list.forEach((b, i) => {
        const option = document.createElement('option');
        option.value = i;
        option.innerText = `Port ${b.port} | ${b.title} (${b.url})`;
        select.appendChild(option);
      });
      document.getElementById('master-select-box').style.display = 'block';
    }

    async function confirmMaster() {
      const index = parseInt(document.getElementById('master').value);
      selectedMasterIndex = index;
      await ipcRenderer.invoke('show-master-alert', selectedMasterIndex);
      alert(`ë§ˆìŠ¤í„°ë¡œ Port ${chromeList[index].port} ì„ íƒë¨`);

      const masterBtn = document.getElementById('master-btn');
      masterBtn.classList.remove('primary');
      masterBtn.classList.add('disabled');
      masterBtn.disabled = true;

      const syncBtn = document.getElementById('sync-btn');
      syncBtn.classList.remove('disabled');
      syncBtn.classList.add('primary');
      syncBtn.disabled = false;
    }

    async function startSync() {
      const count = parseInt(document.getElementById('count').value);
      if (selectedMasterIndex == null) return alert('ë§ˆìŠ¤í„°ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.');
      try {
        await ipcRenderer.invoke('start-sync', selectedMasterIndex, count);
        alert('âœ… ë™ê¸°í™” ì‹œì‘ë¨!');

        const syncBtn = document.getElementById('sync-btn');
        syncBtn.classList.remove('primary');
        syncBtn.classList.add('disabled', 'loading');
        syncBtn.innerText = 'ë™ê¸°í™” ì¤‘...';
        syncBtn.disabled = true;

        const stopBtn = document.getElementById('stop-sync-btn');
        stopBtn.classList.remove('disabled');
        stopBtn.classList.add('primary');
        stopBtn.disabled = false;
      } catch (err) {
        console.error(err);
        alert('âŒ ë™ê¸°í™” ì‹œì‘ ì‹¤íŒ¨');
      }
    }

    function stopSync() {
      alert('ğŸ›‘ ë™ê¸°í™” ì¢…ë£Œ');
      const syncBtn = document.getElementById('sync-btn');
      syncBtn.classList.remove('loading');
      syncBtn.classList.remove('disabled');
      syncBtn.classList.add('primary');
      syncBtn.innerText = '3. ë™ê¸°í™” ì‹œì‘í•˜ê¸°';
      syncBtn.disabled = false;

      const stopBtn = document.getElementById('stop-sync-btn');
      stopBtn.classList.remove('primary');
      stopBtn.classList.add('disabled');
      stopBtn.disabled = true;
    }

    async function closeAllChromes() {
      try {
        const result = await ipcRenderer.invoke('close-all-chromes');
        alert('âŒ ëª¨ë“  í¬ë¡¬ ì°½ì´ ë‹«í˜”ìŠµë‹ˆë‹¤.');
      } catch (err) {
        console.error(err);
        alert('âŒ í¬ë¡¬ ì°½ ë‹«ê¸° ì‹¤íŒ¨');
      }
    }

    function exitApp() {
      window.close();
    }

    function openProfileList() {
      ipcRenderer.invoke('open-profile-list');
    }
  </script>
</body>
</html>